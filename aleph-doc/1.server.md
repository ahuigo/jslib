# aleph.js server
dr run -A server.ts

    routerConfig={routes}
    serve({routerConfig, ssr, dev: { reactRefresh: true, }, unocss: "preset"}) ///server.ts
        AlephConfig = { baseUrl, router: routerConfig, unocss, loaders, optimization };
        Reflect.set(globalThis, "__ALEPH_CONFIG", AlephConfig);
        handler =  async (req: Request, connInfo: ConnInfo)=>Promise
        start_server(handler)

# handler
handler(req,connInfo)

    // server/mod.ts
    1. handle /-/hmr socket
    2. ctx = createContext(req, { connInfo, customHTMLRewriter });
       1. cookie
       2. session
    3. middlewares
    4. transform modules
    5. serve static files
    6. use post middlewares
    7. fetch(req,ctx)
    8. request route api //server/mod.ts
      1. router= await initRouter(options=routerConfig, appDir)  //server/routings.ts
        1. reg = toRouteRegExp(options);
        2. files = getFiles(appDir);
        3. routes = files.foreach(filename=>fn)
           1. pattern = reg.exec(filename);
           2. routes.push([pattern, { pattern, filename }]);
        3. routes.sort(getRouteOrder) // sort by pathname length
        4. return { routes, reg.prefix, appDir, _404, _app};
      2. resp = await fetchRouteData(req, ctx, router, reqData); //server/routings.ts
        1. [ret, meta] = findRoute(router.routes); 
        2. mod = importRouteModule({filename,pattern}=meta, router.appDir)
           1. return routes[pattern.pathname];
           2. rerurn await import(`filename.slice(1)}?ssr&v=`)
        3. return if method !== "GET" || mod.default === undefined || reqData
    9. indexHtml = loadAndFixIndexHtml('index.html') //server/html.ts
        1. htmlRaw = await Deno.readFile(filepath);
        2. [html, hasSSRBody] = checkSSRBody(htmlRaw);
        3. return fixIndexHtml(html, hasSSRBody);
            1. link: href+= "?v=" + deployId;
                1. import(hmr.ts);hot(href).accept();
            2. script: src+= "?v=" + deployId;
                1. import nomodule.ts
            3. body: el.prepend("<ssr-body></ssr-body>");
            3. head:
                1. hot("./index.html").decline()
                2. window.__hmrWebSocketUrl=${JSON.stringify(hmr.url)}
    10. !ssr
        1. etag = `W/${btoa("./index.html").replace(/[^a-z0-9]/g, "")}-${deployId}`;
        2. ctx.headers.set("ETag", etag);
        3. return new Response(indexHtml, { headers: ctx.headers });
    11. ssr: return renderer.fetch(req, ctx, { indexHtml, router, customHTMLRewriter, ssr, isDev, });
    // server/renderer.ts
        1. [url, routeModules, deferedData] = initSSR(req, ctx, router, false);
            1. matches = matchRoutes(url, router); //runtime/core/route.ts
            2. modules = matches.map(async ([ret, meta]) => rmod)
                1. mod = importRouteModule(meta, router.appDir);
                2. rmod = { url,params: ret.pathname.groups,
                        filename: meta.filename, 
                        defaultExport: mod.default,
                        dataCacheTtl: mod?.cacheTtl as (number | undefined),
                    };
                3. if fetcher = dataConfig.get ?? dataConfig.GET
                   1. fetchData=()=>data;
                      1. res = fetcher(req, ctx);
                      2. data = await res.json();
                      3. if dataDefer: deferedData[rmod.url.pathname + rmod.url.search] = data;
                      4. return data
                   2. if dataDefer: rmod.data = fetchData;
                   3. if else: rmod.data = await fetchData();
                4. return rmod
            3. return [ url, modules deferedData, ];
        2. ssrContext= { url, routeModules, headCollection, dataDefer, signal: req.signal,
             bootstrapScripts: [bootstrapScript]}
        3. body = await render(ssrContext); // runtime/react/ssr.ts
           1. App = import("runtime/react/router.ts")
           1. return renderToReadableStream(createElement(App, { ssrContext: ctx }), ctx) // runtime/react/router.ts
                // todo App
        4. inline css: depGraph.shallowWalk(routeModules, (mod)=>fn())
            1. { specifier, inlineCSS } = mod;
            2.  if (inlineCSS) : headCollection.push(`<style data-module-id="${specifier}" ssr>${inlineCSS}</style>`);
        5. build unocss:
        6. ssrRes: Content--Policy
        7. CSP: headers.append("Content-Security-Policy", policy);
        8. stream:
            1. customHTMLRewriter.forEach: rewriter.on(selector, handlers);
            1. rewriter.on("head", {element(el)=>handler})
            1. rewriter.on("ssr-body", {})
            1. rewriter.on("script", {})
        9. return new Response(stream, { headers, status})
