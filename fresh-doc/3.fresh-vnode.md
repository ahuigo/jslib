---
title: fresh vnode(preact)
date: 2022-07-23
private: true
---
# fresh vnode(preact)
Refer to `fresh-ctx.md`

we should know that `_app.tsx` is a layout component.

    // fromManifest in server/context.ts
    this.app=_app.tsx?:DEFAULT_APP
        2. DEFAULT_APP.default= `({ Component }) => h(Component, {})`
        1. _app.jsx.default= `(props) =><props.Component/>`


vnode is rendered component:

    vnode = <Component {...props}>
    vnode = h(Component, props)

# renderToString
it is used to transform vnode to html

    html = renderToString(vnode)
    html = renderToString(<Component {...props}>)
    html = renderToString(h(Component,props}))

it's prototype is:

    function renderToString(
        vnode: VNode,
        context?: any,
        options?: Options
    ): string;

完整的例子：

    $ cat a.tsx
    /** @jsx h */
    import { h } from "preact";
    import { renderToString } from "preact-render-to-string";
    console.log(renderToString(<h1>111</h1>))
    $ deno run a.tsx
    <h1>111</h1>


what it calls within renderToString?

    import {options} from "preact";
    call `options.vnode(vnode)` // preact

we can customize this options.vnode

## options.vnode
we can customize options.vnode

    const originalHook = options.vnode;
    let ignoreNext = false;
    options.vnode = (vnode) => {
      assetHashingHook(vnode);
      const originalType = vnode.type as ComponentType<unknown>;
      if (typeof vnode.type === "function") {
        const island = ISLANDS.find((island) => island.component === originalType);
        if (island) {
          if (ignoreNext) {
            ignoreNext = false;
            return;
          }
          ENCOUNTERED_ISLANDS.add(island);
          vnode.type = (props) => {
            ignoreNext = true;
            const child = h(originalType, props);
            ISLAND_PROPS.push(props);
            return h(
              `!--frsh-${island.id}:${ISLAND_PROPS.length - 1}--`,
              null,
              child,
            );
          };
        }
      }
      if (originalHook) originalHook(vnode);
    };

The code above completed these things.
1. check is vnode is island
2. add island to `ENCOUNTERED_ISLANDS`
2. add props to `ISLAND_PROPS`
3. wrap vnode with ``!--frsh-${island.id}:${ISLAND_PROPS.length - 1}--``
3. call `originalHook(vnode) = options.vnode; `

# island
From above example, We see, `ENCOUNTERED_ISLANDS` is collected when call `renderToString`
